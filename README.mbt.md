## MoonBit Async â€” æœ€ä½³å®è·µç¤ºä¾‹åº“ï¼ˆè¯¦ç»†æ¶æ„è®¾è®¡ï¼‰

> æœ¬æ–‡æ¡£æ˜¯ `README.md` çš„**æ·±åº¦æ‰©å±•ç‰ˆæœ¬**ï¼Œé¢å‘éœ€è¦ç†è§£æ¶æ„è®¾è®¡ã€ä½¿ç”¨åœºæ™¯ã€ä»¥åŠ"ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡"çš„å¼€å‘è€…ã€‚

ä¸ºäº†æ¨å¹¿ `moonbitlang/async` çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬æä¾›ä¸€ä¸ª **"æ‹¿æ¥å°±èƒ½å­¦ä¼š"** çš„ç¤ºä¾‹ä»“åº“ï¼š
- **ç¤ºä¾‹é©±åŠ¨**ï¼šæ¯ä¸ªå…³é”®æ¨¡å¼åœ¨ `examples/` ä¸­éƒ½æœ‰å¯è¿è¡Œä»£ç  + æµ‹è¯•
- **å·¥ç¨‹åŒ–æ¨¡æ¿**ï¼šæŠŠ"è¶…æ—¶/é‡è¯•/é”™è¯¯å½’ä¸€åŒ–"ç­‰ç­–ç•¥æ”¶å£åˆ° `infra/`
- **æœ€ä½³å®è·µæ­£æ–‡**ï¼š`docs/best_practices.mbt.md` ç»™å‡ºåŸåˆ™ã€åæ¨¡å¼ä¸ PR æ£€æŸ¥æ¸…å•
- **ç³»ç»ŸåŒ–æ•™å­¦åŒ…**ï¼š`src/` æä¾›è¦†ç›–æ›´å…¨çš„"åŠŸèƒ½ç›®å½•å¼"ç¤ºä¾‹ä¸å¤§é‡æµ‹è¯•ï¼ˆä½œä¸ºä¸»æ•™æï¼‰

---

## ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ¶æ„è®¾è®¡æ€æƒ³](#æ¶æ„è®¾è®¡æ€æƒ³)
- [ä»“åº“å¯¼èˆª](#ä»“åº“å¯¼èˆª)
- [å­¦ä¹ è·¯å¾„](#å­¦ä¹ è·¯å¾„)
- [ä½¿ç”¨åœºæ™¯ä¸æ¨¡å¼](#ä½¿ç”¨åœºæ™¯ä¸æ¨¡å¼)
- [ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡](#ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡)
- [å¦‚ä½•é›†æˆåˆ°ä½ çš„é¡¹ç›®](#å¦‚ä½•é›†æˆåˆ°ä½ çš„é¡¹ç›®)
- [ç»™ AI çš„ä½¿ç”¨æ–¹å¼](#ç»™-ai-çš„ä½¿ç”¨æ–¹å¼)

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

`moonbitlang/async` å½“å‰åŒ…å«éƒ¨åˆ† `extern "C"` èƒ½åŠ›ï¼Œå› æ­¤ **wasm-gc backend ä¼šå¤±è´¥**ã€‚æœ¬ä»“åº“å»ºè®®ä½¿ç”¨ nativeï¼š

```bash
moon check --target native
moon test --target native
```

### 5 åˆ†é’ŸéªŒè¯

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/CGaaaaaa/Async_best_practices.git
cd Async_best_practices

# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåº”è¯¥å…¨ç»¿ï¼Œ33+ async testsï¼‰
moon test --target native

# è¿è¡Œæœ€å°ç¤ºä¾‹
cd examples/checkout
moon test --target native
```

å¦‚æœæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œè¯´æ˜ä½ çš„ç¯å¢ƒå·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å­¦ä¹ ã€‚

---

## æ¶æ„è®¾è®¡æ€æƒ³

### æ ¸å¿ƒé—®é¢˜ï¼šå¼‚æ­¥ä»£ç ä¸ºä»€ä¹ˆéš¾å†™ï¼Ÿ

åœ¨çœŸå®ä¸šåŠ¡ä¸­ï¼Œå¼‚æ­¥ç¼–ç¨‹å¸¸è§çš„ç—›ç‚¹ï¼š

1. **ç­–ç•¥æ•£è½**ï¼šè¶…æ—¶ã€é‡è¯•ã€é™æµé€»è¾‘æ•£å¸ƒåœ¨å„ä¸ªä¸šåŠ¡æ–‡ä»¶ä¸­
   - éš¾ä»¥ç»Ÿä¸€è°ƒå‚ï¼ˆä¾‹å¦‚"æ‰€æœ‰ç¬¬ä¸‰æ–¹è°ƒç”¨éƒ½æ”¹ä¸º 3 ç§’è¶…æ—¶"ï¼‰
   - ä»£ç å®¡æŸ¥å›°éš¾ï¼ˆæ¯ä¸ªæ–‡ä»¶éƒ½è¦æ£€æŸ¥æ˜¯å¦æœ‰è¶…æ—¶ï¼‰

2. **å–æ¶ˆå¤±æ§**ï¼šæ²¡æœ‰ç»“æ„åŒ–å¹¶å‘ï¼Œä»»åŠ¡"é‡ç”Ÿ"åˆ›å»º
   - çˆ¶ä»»åŠ¡å–æ¶ˆæ—¶ï¼Œå­ä»»åŠ¡ç»§ç»­è¿è¡Œæµªè´¹èµ„æº
   - æ— æ³•è¿½è¸ªä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸ

3. **èµ„æºè€—å°½**ï¼šæ²¡æœ‰å¹¶å‘æ§åˆ¶
   - DB è¿æ¥æ± è¢«æ‰“æ»¡
   - ç¬¬ä¸‰æ–¹ API è¢«é™æµï¼ˆå› ä¸ºå¹¶å‘è¿‡é«˜ï¼‰

4. **æµ‹è¯•å›°éš¾**ï¼šå¼‚æ­¥ä»£ç éš¾ä»¥å¤ç°
   - è¶…æ—¶åœºæ™¯éœ€è¦çœŸå®ç­‰å¾…ï¼Ÿ
   - é‡è¯•é€»è¾‘éœ€è¦çœŸå®å¤±è´¥å‡ æ¬¡ï¼Ÿ

### æœ¬ä»“åº“çš„è§£å†³æ–¹æ¡ˆ

#### 1. ä¸‰å±‚æ¶æ„ï¼šä¸šåŠ¡ / infra / åº•å±‚ Async

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡å±‚ (examples/checkout.mbt)      â”‚  â† åªè¡¨è¾¾"åšä»€ä¹ˆ"
â”‚  checkout_orders([101, 102])        â”‚
â”‚  â””â”€> @infra.call_payment_with_retry â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç­–ç•¥æ”¶å£å±‚ (infra/clients.mbt)      â”‚  â† ç»Ÿä¸€"æ€ä¹ˆåš"
â”‚  call_with_timeout_and_retry(...)   â”‚
â”‚  â””â”€> @async.with_timeout_opt        â”‚
â”‚  â””â”€> @async.retry                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº•å±‚ Async åº“ (moonbitlang/async)   â”‚  â† æä¾›åŸè¯­
â”‚  with_timeout_opt / retry / ...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¥½å¤„**ï¼š
- ä¸šåŠ¡ä»£ç ç®€æ´ï¼šåªå¤„ç† `Result[X, String]`ï¼Œä¸å…³å¿ƒè¶…æ—¶/é‡è¯•ç»†èŠ‚
- ç­–ç•¥å¯å®¡æŸ¥ï¼šæ‰€æœ‰è¶…æ—¶å‚æ•°ã€é‡è¯•ç­–ç•¥éƒ½åœ¨ `infra/` ä¸­ï¼Œæ˜“äºç»Ÿä¸€è°ƒæ•´
- æµ‹è¯•å®¹æ˜“ï¼šä¸šåŠ¡å±‚æµ‹è¯•åªéœ€ mock `infra`ï¼Œä¸éœ€è¦çœŸå® sleep

#### 2. ç»“æ„åŒ–å¹¶å‘ï¼ˆStructured Concurrencyï¼‰

**åæ¨¡å¼**ï¼š
```moonbit
// âŒ é‡ç”Ÿ spawnï¼Œä»»åŠ¡å¤±æ§
async fn bad_example() -> Int {
  let t1 = @async.spawn(fn() { ... })  // è°æ¥å–æ¶ˆå®ƒï¼Ÿ
  let t2 = @async.spawn(fn() { ... })  // çˆ¶ä»»åŠ¡é€€å‡ºæ—¶å®ƒè¿˜åœ¨è·‘ï¼Ÿ
  t1.wait() + t2.wait()
}
```

**æ¨èæ¨¡å¼**ï¼š
```moonbit
// âœ… ç”¨ TaskGroup ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
async fn good_example() -> Int {
  @async.with_task_group(fn(group) {
    let t1 = group.spawn(fn() { ... })
    let t2 = group.spawn(fn() { ... })
    // group é€€å‡ºæ—¶ï¼Œæ‰€æœ‰å­ä»»åŠ¡è‡ªåŠ¨å–æ¶ˆ
    t1.wait() + t2.wait()
  })
}
```

**å¥½å¤„**ï¼š
- ä»»åŠ¡æœ‰"çˆ¶äº²"ï¼ˆTaskGroupï¼‰ï¼Œç”Ÿå‘½å‘¨æœŸå¯æ§
- å–æ¶ˆä¼ æ’­ï¼šçˆ¶ä»»åŠ¡å–æ¶ˆæ—¶ï¼Œå­ä»»åŠ¡ä¹Ÿè¢«å–æ¶ˆ
- fail-fastï¼šé»˜è®¤ `allow_failure=false`ï¼Œä¸€ä¸ªä»»åŠ¡å¤±è´¥ä¼šå–æ¶ˆå…„å¼Ÿä»»åŠ¡

#### 3. æœ‰é™å¹¶å‘ä¸èƒŒå‹

**é—®é¢˜åœºæ™¯**ï¼š
- ä½ çš„æœåŠ¡è°ƒç”¨ç¬¬ä¸‰æ–¹ APIï¼Œæ²¡æœ‰é™æµ â†’ API æä¾›å•†è¿”å› 429ï¼ˆToo Many Requestsï¼‰
- ä½ çš„æœåŠ¡å¹¶å‘æŸ¥è¯¢ DBï¼Œæ²¡æœ‰è¿æ¥æ± ä¸Šé™ â†’ DB è¿æ¥è€—å°½

**æ–¹æ¡ˆ**ï¼š
```moonbit
// ç”¨ Semaphore é™åˆ¶æœ€å¤§å¹¶å‘
let sem = @semaphore.Semaphore::new(10)  // æœ€å¤š 10 ä¸ªå¹¶å‘

for item in items {
  sem.acquire()  // é˜»å¡ç›´åˆ°æœ‰ç©ºé—²æ§½ä½
  group.spawn_bg(fn() {
    process(item)
    sem.release()
  })
}
```

**å¥½å¤„**ï¼š
- ä¿æŠ¤å¤–éƒ¨ä¾èµ–ï¼ˆDBã€APIï¼‰ä¸è¢«æ‰“çˆ†
- ä¿æŠ¤è‡ªèº«èµ„æºï¼ˆå†…å­˜ã€CPUï¼‰ä¸è€—å°½

#### 4. æµ‹è¯•ä¼˜å…ˆï¼ˆTestability Firstï¼‰

æœ¬ä»“åº“æ‰€æœ‰ç¤ºä¾‹éƒ½é…å¥— `async test`ï¼š
- **å¿«ç…§æµ‹è¯•**ï¼šç”¨ `inspect(content=...)` éªŒè¯è¾“å‡º
- **åœºæ™¯è¦†ç›–**ï¼šæˆåŠŸ/è¶…æ—¶/ç¬æ€å¤±è´¥/å–æ¶ˆä¼ æ’­
- **å¯å¤ç°**ï¼šä¸ä¾èµ–çœŸå®å¤–éƒ¨æœåŠ¡ï¼ˆç”¨ mock æˆ–è®¡æ•°å™¨æ¨¡æ‹Ÿï¼‰

---

## ä»“åº“å¯¼èˆª

### 1. å…¥å£æ–‡æ¡£ï¼ˆå…ˆçœ‹è¿™é‡Œï¼‰

- **`README.md`**ï¼ˆæœ¬ä»“åº“ GitHub é¦–é¡µï¼‰ï¼šå¿«é€Ÿä¸Šæ‰‹ã€ç¤ºä¾‹ç´¢å¼•
- **`README.mbt.md`**ï¼ˆæœ¬æ–‡ä»¶ï¼‰ï¼šæ¶æ„è®¾è®¡ã€ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡
- **`docs/best_practices.mbt.md`**ï¼šæ ¸å¿ƒåŸåˆ™ã€åæ¨¡å¼å¯¹æ¯”ã€PR æ£€æŸ¥æ¸…å•

### 2. ç­–ç•¥æ”¶å£å±‚ï¼ˆå¤åˆ¶åˆ°ä½ çš„é¡¹ç›®ï¼‰

- **`infra/README.mbt.md`**ï¼šç­–ç•¥æ”¶å£çš„è®¾è®¡æ€æƒ³
- **`infra/clients.mbt`**ï¼šé€šç”¨ `call_with_timeout_and_retry` å®ç°
- **`infra/clients_test.mbt`**ï¼šè¶…æ—¶/é‡è¯•çš„æµ‹è¯•ç”¨ä¾‹

### 3. å¯è¿è¡Œç¤ºä¾‹ï¼ˆä»ç®€å•åˆ°å¤æ‚ï¼‰

| ç¤ºä¾‹ | æ ¸å¿ƒçŸ¥è¯†ç‚¹ | æ¨èé˜…è¯»é¡ºåº |
|------|-----------|-------------|
| `examples/checkout` | ä¸šåŠ¡ä¸ infra åˆ†å±‚ã€å¿«ç…§æµ‹è¯• | 1ï¸âƒ£ |
| `examples/task_group` | ç»“æ„åŒ–å¹¶å‘ã€fail-fast | 2ï¸âƒ£ |
| `examples/retry_timeout` | è¶…æ—¶/é‡è¯•ç­–ç•¥ | 3ï¸âƒ£ |
| `examples/semaphore_limiter` | å¹¶å‘é™æµ | 4ï¸âƒ£ |
| `examples/pipeline_queue` | ç”Ÿäº§è€…-æ¶ˆè´¹è€…æµæ°´çº¿ | 5ï¸âƒ£ |

æ¯ä¸ªç¤ºä¾‹éƒ½æœ‰ç‹¬ç«‹çš„ `README.mbt.md`ï¼Œè§£é‡Šè®¾è®¡æ„å›¾ã€å…³é”®ä»£ç ã€æµ‹è¯•ç­–ç•¥ã€‚

### 4. ç³»ç»ŸåŒ–æ•™å­¦åŒ…ï¼ˆAPI æ‰‹å†Œï¼‰

- **`src/README.mbt.md`**ï¼šå®Œæ•´ API ç´¢å¼•
- **`src/Async_best_practices.mbt`**ï¼š17 ä¸ªç¤ºä¾‹å‡½æ•°ï¼Œè¦†ç›–æ‰€æœ‰ Async åŸè¯­
- **`src/Async_best_practices_test.mbt`**ï¼š33+ æµ‹è¯•ç”¨ä¾‹

---

## å­¦ä¹ è·¯å¾„

### è·¯å¾„ Aï¼šå¿«é€Ÿä¸Šæ‰‹ä¸šåŠ¡å†™æ³•ï¼ˆ1 å°æ—¶ï¼‰

é€‚åˆï¼šéœ€è¦ç«‹å³åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Async çš„å¼€å‘è€…

1. **10 åˆ†é’Ÿ**ï¼šè·‘é€š `examples/checkout`ï¼Œç†è§£ä¸šåŠ¡ä¸ infra åˆ†å±‚
2. **20 åˆ†é’Ÿ**ï¼šè·‘é€š `examples/task_group` å’Œ `examples/retry_timeout`
3. **30 åˆ†é’Ÿ**ï¼šé˜…è¯» `docs/best_practices.mbt.md` çš„"PR æ£€æŸ¥æ¸…å•"

å®Œæˆåï¼Œä½ åº”è¯¥èƒ½ï¼š
- åœ¨ä¸šåŠ¡ä»£ç ä¸­æ­£ç¡®è°ƒç”¨ `@infra` å°è£…
- ä½¿ç”¨ `TaskGroup` ç®¡ç†å¹¶å‘ä»»åŠ¡
- ç”¨ `inspect` å†™å¿«ç…§æµ‹è¯•

### è·¯å¾„ Bï¼šç³»ç»Ÿå­¦ä¹  Async APIï¼ˆ2 å°æ—¶ï¼‰

é€‚åˆï¼šéœ€è¦æ·±å…¥ç†è§£ Async åº“çš„å¼€å‘è€…

1. **30 åˆ†é’Ÿ**ï¼šé˜…è¯» `src/Async_best_practices.mbt` çš„å‰ 5 ä¸ªç¤ºä¾‹
2. **30 åˆ†é’Ÿ**ï¼šè¿è¡Œ `moon test --target native src/`ï¼Œå¯¹ç…§è¾“å‡ºç†è§£è¡Œä¸º
3. **60 åˆ†é’Ÿ**ï¼šæŒ‰ä¸»é¢˜æŸ¥é˜…ï¼š
   - è¶…æ—¶ï¼š`demo_with_timeout` / `demo_with_timeout_opt`
   - é‡è¯•ï¼š`demo_retry_fixed_delay` / `demo_retry_exponential`
   - é™æµï¼š`demo_semaphore` / `demo_try_acquire`
   - é˜Ÿåˆ—ï¼š`demo_queue_pipeline`

å®Œæˆåï¼Œä½ åº”è¯¥èƒ½ï¼š
- ç†è§£ `with_timeout` vs `with_timeout_opt` çš„åŒºåˆ«
- é€‰æ‹©åˆé€‚çš„é‡è¯•ç­–ç•¥ï¼ˆå›ºå®šå»¶è¿Ÿ vs æŒ‡æ•°é€€é¿ï¼‰
- æ­£ç¡®ä½¿ç”¨ `Semaphore` é™æµ

### è·¯å¾„ Cï¼šä»£ç å®¡æŸ¥ä¸æ¶æ„è®¾è®¡ï¼ˆ1 å°æ—¶ï¼‰

é€‚åˆï¼šéœ€è¦å®¡æŸ¥ä»–äººä»£ç æˆ–è®¾è®¡æ¶æ„çš„ Tech Lead

1. **20 åˆ†é’Ÿ**ï¼šé˜…è¯» `docs/best_practices.mbt.md` çš„æ‰€æœ‰åŸåˆ™
2. **20 åˆ†é’Ÿ**ï¼šå¯¹ç…§ `examples/` çš„æ­£ä¾‹ï¼Œç†è§£"å¥½ä»£ç "çš„æ ‡å‡†
3. **20 åˆ†é’Ÿ**ï¼šç”¨ PR æ£€æŸ¥æ¸…å•å®¡æŸ¥ä½ çš„é¡¹ç›®ä»£ç 

å®Œæˆå,ä½ åº”è¯¥èƒ½ï¼š
- è¯†åˆ«å¸¸è§åæ¨¡å¼ï¼ˆé‡ç”Ÿ spawnã€ç¼ºå°‘è¶…æ—¶ã€æ»¥ç”¨é‡è¯•ï¼‰
- æå‡ºæ”¹è¿›æ–¹æ¡ˆï¼ˆä¾‹å¦‚"è¿™é‡Œåº”è¯¥åŠ é™æµ"ï¼‰
- è¯„ä¼°ä»£ç çš„å¯æµ‹è¯•æ€§

---

## ä½¿ç”¨åœºæ™¯ä¸æ¨¡å¼

### åœºæ™¯ 1ï¼šè°ƒç”¨ç¬¬ä¸‰æ–¹ API

**éœ€æ±‚**ï¼šè°ƒç”¨æ”¯ä»˜ç½‘å…³ï¼Œéœ€è¦è¶…æ—¶ä¿æŠ¤ + ç¬æ€å¤±è´¥é‡è¯•

**æ–¹æ¡ˆ**ï¼š
```moonbit
// infra/clients.mbt
pub async fn call_payment_api(order_id : Int) -> Result[String, String] {
  call_with_timeout_and_retry(3000, fn() {  // 3 ç§’è¶…æ—¶
    // çœŸå®çš„ HTTP è°ƒç”¨
    http_post("/api/pay", order_id)
  })
}

// ä¸šåŠ¡å±‚
let result = @infra.call_payment_api(101)
match result {
  Ok(txn_id) => log("success: {txn_id}")
  Err(e) => log("failed: {e}")
}
```

**å¥½å¤„**ï¼š
- è¶…æ—¶å‚æ•°é›†ä¸­åœ¨ `infra`ï¼Œä¸šåŠ¡å±‚æ— éœ€å…³å¿ƒ
- é‡è¯•ç­–ç•¥å¯ç»Ÿä¸€è°ƒæ•´ï¼ˆä¾‹å¦‚æ”¹ä¸ºæŒ‡æ•°é€€é¿ï¼‰

### åœºæ™¯ 2ï¼šå¹¶è¡ŒæŸ¥è¯¢å¤šä¸ªæ•°æ®æº

**éœ€æ±‚**ï¼šåŒæ—¶æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€è®¢å•å†å²ã€æ¨èåˆ—è¡¨ï¼Œä»»ä¸€å¤±è´¥åˆ™æ•´ä½“å¤±è´¥

**æ–¹æ¡ˆ**ï¼š
```moonbit
@async.with_task_group(fn(group) {
  let t1 = group.spawn(fn() { @infra.fetch_user(uid) })
  let t2 = group.spawn(fn() { @infra.fetch_orders(uid) })
  let t3 = group.spawn(fn() { @infra.fetch_recommendations(uid) })
  
  // ä»»ä¸€å¤±è´¥ä¼šè‡ªåŠ¨å–æ¶ˆå…¶ä»–ä»»åŠ¡ï¼ˆfail-fastï¼‰
  (t1.wait(), t2.wait(), t3.wait())
})
```

**å¥½å¤„**ï¼š
- ä¸‰ä¸ªæŸ¥è¯¢å¹¶è¡Œæ‰§è¡Œï¼ˆæ€§èƒ½ï¼‰
- ä¸€ä¸ªå¤±è´¥æ—¶ç«‹å³å–æ¶ˆå…¶ä»–ï¼ˆèŠ‚çœèµ„æºï¼‰

### åœºæ™¯ 3ï¼šæ‰¹é‡å¤„ç†ä»»åŠ¡ï¼ˆæœ‰å¹¶å‘ä¸Šé™ï¼‰

**éœ€æ±‚**ï¼šå¤„ç† 1000 ä¸ªè®¢å•ï¼Œä½† DB è¿æ¥æ± åªæœ‰ 20 ä¸ª

**æ–¹æ¡ˆ**ï¼š
```moonbit
let sem = @semaphore.Semaphore::new(20)
@async.with_task_group(fn(group) {
  for order in orders {
    group.spawn_bg(fn() raise {
      sem.acquire()
      process_order(order)  // çœŸå® DB æ“ä½œ
      sem.release()
    })
  }
})
```

**å¥½å¤„**ï¼š
- æœ€å¤š 20 ä¸ªå¹¶å‘ï¼Œä¸ä¼šæ‰“çˆ† DB
- ç”¨ `spawn_bg` é¿å…é˜»å¡ï¼ˆåå°ä»»åŠ¡ï¼‰

### åœºæ™¯ 4ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æµæ°´çº¿

**éœ€æ±‚**ï¼šçˆ¬è™«æŠ“å– URLï¼Œå¤šä¸ª worker å¹¶è¡Œè§£æå†…å®¹

**æ–¹æ¡ˆ**ï¼š
```moonbit
@async.with_task_group(fn(group) {
  let queue = @aqueue.Queue::new()
  
  // Producer
  group.spawn_bg(fn() {
    for url in urls {
      queue.put(url)
    }
    queue.put("STOP")  // ç»ˆæ­¢ä¿¡å·
  })
  
  // Consumers
  for _ in 0..<workers {
    group.spawn_bg(fn() {
      for {
        let url = queue.get()
        guard url != "STOP" else { break }
        parse_and_save(url)
      }
    })
  }
})
```

**å¥½å¤„**ï¼š
- è§£è€¦ç”Ÿäº§ä¸æ¶ˆè´¹
- å¤š worker å¹¶è¡Œå¤„ç†

---

## ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡

### Q1ï¼šä¸ºä»€ä¹ˆè¦æœ‰ `infra/` å±‚ï¼Ÿ

**A**ï¼š
- **ç»Ÿä¸€æ²»ç†**ï¼šæ‰€æœ‰å¤–éƒ¨è°ƒç”¨çš„è¶…æ—¶/é‡è¯•ç­–ç•¥éƒ½åœ¨ä¸€å¤„ï¼Œæ–¹ä¾¿è°ƒæ•´
- **ä»£ç å®¡æŸ¥**ï¼šå®¡æŸ¥æ—¶åªéœ€æ£€æŸ¥ `infra/`ï¼Œæ— éœ€é€ä¸ªæ£€æŸ¥ä¸šåŠ¡æ–‡ä»¶
- **æµ‹è¯•ç®€åŒ–**ï¼šä¸šåŠ¡å±‚æµ‹è¯•æ—¶ mock `infra`ï¼Œä¸éœ€è¦çœŸå® sleep

### Q2ï¼šä¸ºä»€ä¹ˆå¼ºè°ƒ `TaskGroup`ï¼Ÿ

**A**ï¼š
- **èµ„æºç®¡ç†**ï¼šé˜²æ­¢ä»»åŠ¡æ³„æ¼ï¼ˆçˆ¶ä»»åŠ¡é€€å‡ºæ—¶å­ä»»åŠ¡è¿˜åœ¨è·‘ï¼‰
- **å–æ¶ˆä¼ æ’­**ï¼šçˆ¶ä»»åŠ¡å–æ¶ˆæ—¶ï¼Œå­ä»»åŠ¡ä¹Ÿè¢«å–æ¶ˆ
- **fail-fast**ï¼šå…³é”®ä»»åŠ¡å¤±è´¥æ—¶ï¼Œç«‹å³å–æ¶ˆå…„å¼Ÿä»»åŠ¡ï¼ˆé¿å…æµªè´¹èµ„æºï¼‰

### Q3ï¼šä¸ºä»€ä¹ˆç¤ºä¾‹éƒ½ç”¨ `inspect` åšæµ‹è¯•ï¼Ÿ

**A**ï¼š
- **å¿«ç…§æµ‹è¯•**ï¼šéªŒè¯å®Œæ•´è¾“å‡ºï¼ˆä¸åªæ˜¯æŸä¸ªå­—æ®µï¼‰
- **å¯è¯»æ€§**ï¼šæµ‹è¯•ä»£ç å³æ–‡æ¡£ï¼Œä¸€çœ¼çœ‹æ‡‚é¢„æœŸè¡Œä¸º
- **ç¨³å®šæ€§**ï¼šä¸ä¾èµ–çœŸå®å¤–éƒ¨æœåŠ¡ï¼Œæµ‹è¯•100%å¯å¤ç°

### Q4ï¼šä¸ºä»€ä¹ˆ `src/` å’Œ `examples/` éƒ½æœ‰ç¤ºä¾‹ï¼Ÿ

**A**ï¼š
- `src/`ï¼š**API æ‰‹å†Œ**ï¼Œç³»ç»ŸåŒ–è¦†ç›–æ‰€æœ‰åŸè¯­ï¼ˆé€‚åˆ"æŸ¥æ‰¾æŸä¸ª API æ€ä¹ˆç”¨"ï¼‰
- `examples/`ï¼š**ä¸šåŠ¡åœºæ™¯**ï¼Œå±•ç¤ºå¦‚ä½•ç»„åˆå¤šä¸ªåŸè¯­ï¼ˆé€‚åˆ"å­¦ä¹ å¦‚ä½•å†™çœŸå®ä»£ç "ï¼‰

### Q5ï¼šä¸ºä»€ä¹ˆä¸æ”¯æŒ `wasm-gc`ï¼Ÿ

**A**ï¼š`moonbitlang/async` å½“å‰ç”¨äº† `extern "C"` è°ƒç”¨ native èƒ½åŠ›ï¼ˆä¾‹å¦‚ sleepï¼‰ã€‚æœªæ¥å¯èƒ½ä¼šæä¾›çº¯ WebAssembly å®ç°ã€‚

---

## å¦‚ä½•é›†æˆåˆ°ä½ çš„é¡¹ç›®

### æ–¹å¼ 1ï¼šå¤åˆ¶ `infra/` æ¨¡æ¿

```bash
# å¤åˆ¶åˆ°ä½ çš„é¡¹ç›®
cp -r infra/ your-project/infra/

# ä¿®æ”¹ your-project/infra/clients.mbt
# æŠŠ mock å®ç°æ›¿æ¢ä¸ºçœŸå® HTTP/DB è°ƒç”¨

# åœ¨ä¸šåŠ¡ä»£ç ä¸­å¼•å…¥
{
  "import": ["your-username/your-project/infra"]
}
```

### æ–¹å¼ 2ï¼šä½œä¸ºä¾èµ–å¼•å…¥ï¼ˆå¦‚æœå‘å¸ƒåˆ° Mooncakesï¼‰

```json
{
  "import": [
    "CGaaaaaa/async-best-practices/infra",
    "CGaaaaaa/async-best-practices/src"
  ]
}
```

### é›†æˆæ­¥éª¤

1. **è¯†åˆ«å¤–éƒ¨è°ƒç”¨**ï¼šæ‰¾å‡ºä»£ç ä¸­æ‰€æœ‰ HTTP/DB/RPC è°ƒç”¨
2. **å°è£…åˆ° infra**ï¼šæŠŠæ¯ç§è°ƒç”¨å°è£…ä¸º `call_xxx_with_retry`
3. **ä¸šåŠ¡å±‚æ”¹é€ **ï¼šä¸šåŠ¡ä»£ç åªè°ƒç”¨ `@infra.call_xxx`
4. **è¡¥å……æµ‹è¯•**ï¼šç”¨ `inspect` éªŒè¯ä¸šåŠ¡é€»è¾‘

---

## ç»™ AI çš„ä½¿ç”¨æ–¹å¼

### å­¦ä¹ é˜¶æ®µ

1. **ä¼˜å…ˆé˜…è¯»** `docs/best_practices.mbt.md`ï¼ˆäº†è§£åŸåˆ™ï¼‰
2. **æŒ‰é¡ºåºè¿è¡Œ** `examples/`ï¼ˆä»ç®€å•åˆ°å¤æ‚ï¼‰
3. **æŸ¥é˜… API** `src/Async_best_practices.mbt`ï¼ˆæŸ¥æ‰¾å…·ä½“ç”¨æ³•ï¼‰

### å†™ä¸šåŠ¡ä»£ç æ—¶

1. **å¤ç”¨ infra æ¨¡å¼**ï¼šä¼˜å…ˆç”¨ `@infra.call_with_timeout_and_retry`
2. **ç”¨ TaskGroup**ï¼šæ‰€æœ‰å¹¶å‘éƒ½ç”¨ `with_task_group` åŒ…èµ·æ¥
3. **åŠ é™æµ**ï¼šå¤–éƒ¨è°ƒç”¨å¿…é¡»ç”¨ `Semaphore` é™æµ
4. **å†™æµ‹è¯•**ï¼šç”¨ `inspect` åšå¿«ç…§æµ‹è¯•

### ä»£ç å®¡æŸ¥æ—¶

å¯¹ç…§ `docs/best_practices.mbt.md` çš„ PR æ£€æŸ¥æ¸…å•ï¼š
- âœ… å¤–éƒ¨è°ƒç”¨æœ‰è¶…æ—¶ï¼Ÿ
- âœ… é‡è¯•ç­–ç•¥åˆç†ï¼Ÿ
- âœ… ç”¨äº† TaskGroupï¼Ÿ
- âœ… æœ‰å¹¶å‘ä¸Šé™ï¼Ÿ
- âœ… æµ‹è¯•è¦†ç›–äº†è¶…æ—¶/å–æ¶ˆåœºæ™¯ï¼Ÿ

---

## å¸¸è§é—®é¢˜

### Qï¼šä¸ºä»€ä¹ˆæµ‹è¯•éœ€è¦ `--target native`ï¼Ÿ

Aï¼š`moonbitlang/async` ç”¨äº† `extern "C"`ï¼Œ`wasm-gc` æš‚ä¸æ”¯æŒã€‚æœªæ¥å¯èƒ½æ”¹è¿›ã€‚

### Qï¼š`with_timeout` å’Œ `with_timeout_opt` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

Aï¼š
- `with_timeout`ï¼šè¶…æ—¶æ—¶ `raise Failure`ï¼ˆä¼šå–æ¶ˆçˆ¶ä»»åŠ¡ï¼‰
- `with_timeout_opt`ï¼šè¶…æ—¶æ—¶è¿”å› `None`ï¼ˆä¸å½±å“çˆ¶ä»»åŠ¡ï¼‰

æ¨èï¼šä¸šåŠ¡å±‚ç”¨ `with_timeout_opt`ï¼Œåœ¨ infra å±‚è½¬ä¸º `Result`ã€‚

### Qï¼šä»€ä¹ˆæ—¶å€™ç”¨ `spawn_bg`ï¼Ÿ

Aï¼šåå°å¯é€‰ä»»åŠ¡ï¼ˆä¾‹å¦‚æ‰“ç‚¹ã€é¢„çƒ­ï¼‰ï¼Œå…è®¸å¤±è´¥ä¸”ä¸å½±å“ä¸»æµç¨‹ã€‚

### Qï¼šå¦‚ä½•è°ƒè¯•å¼‚æ­¥ä»£ç ï¼Ÿ

Aï¼š
1. ç”¨ `log.write_string` æ‰“å°æ—¶åº
2. ç”¨ `inspect` éªŒè¯è¾“å‡º
3. å‡å°‘å¹¶å‘ï¼ˆæ”¹ä¸ºä¸²è¡Œï¼‰æ’æŸ¥é—®é¢˜

---

## å»¶ä¼¸é˜…è¯»

- [MoonBit Async å®˜æ–¹æ–‡æ¡£](https://docs.moonbitlang.com/async)
- [Structured Concurrency è®ºæ–‡](https://en.wikipedia.org/wiki/Structured_concurrency)
- [moonbitlang/async æºç ](https://github.com/moonbitlang/async)

---

**Happy Async Programming! ğŸš€**

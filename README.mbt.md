# MoonBit Async æœ€ä½³å®è·µç¤ºä¾‹åº“

æœ¬ä»“åº“ä»¥å¯è¿è¡Œã€å¯æµ‹è¯•çš„ç¤ºä¾‹æ–¹å¼ï¼Œç³»ç»Ÿå±•ç¤º `moonbitlang/async` çš„é«˜æ•ˆç”¨æ³•ä¸æœ€ä½³å®è·µã€‚

## ğŸ¯ é¡¹ç›®äº®ç‚¹

- ğŸ‰ **100% API è¦†ç›–ç‡**ï¼ˆ28/28 APIï¼Œå®Œæ•´è¦†ç›–ï¼ï¼‰
- âœ… **25 ä¸ªå®Œæ•´ç¤ºä¾‹**ï¼ˆå…¥é—¨ 8 ä¸ª + é«˜çº§ 17 ä¸ªï¼Œå…¶ä¸­ 1 ä¸ªä¸ºä¸šåŠ¡ç»¼åˆç¤ºä¾‹ï¼‰
- âœ… **100% æµ‹è¯•é€šè¿‡ç‡**ï¼ˆæ‰€æœ‰ç¤ºä¾‹å‡æœ‰å¿«ç…§æµ‹è¯•ï¼‰
- âœ… **çº¦ 1600 è¡Œç²¾å¿ƒè®¾è®¡çš„ä»£ç **

## ğŸ“ é¡¹ç›®ç»“æ„

- ç¤ºä¾‹é›†ä¸­åœ¨ `src/` ä¸»åŒ…ä¸­
- æµ‹è¯•é‡‡ç”¨ `inspect(...)` å¿«ç…§ï¼Œä¾¿äºå­¦ä¹ ä¸å›å½’
- ç›®å‰æ¨èåœ¨ native ç›®æ ‡ä¸‹è¿è¡Œï¼ˆè§ä¸‹æ–‡"ç›®æ ‡è¯´æ˜"ï¼‰

æ›´å¤šç³»ç»ŸåŒ–è®²è§£è¯·é˜…è¯»ï¼š`docs/best_practices.mbt.md`

## ç¯å¢ƒè¦æ±‚

- å·²å®‰è£… MoonBit å·¥å…·é“¾ï¼ˆå‚è€ƒå®˜æ–¹æ–‡æ¡£ `https://docs.moonbitlang.com`ï¼‰
- æ¨èä½¿ç”¨ native ç›®æ ‡ï¼›macOS å»ºè®®å®‰è£… Xcode Command Line Tools ä»¥ç¡®ä¿ C å·¥å…·é“¾å¯ç”¨

## å¿«é€Ÿå¼€å§‹

1) åœ¨æ¨¡å— `moon.mod.json` ä¸­åŠ å…¥ä¾èµ–ï¼š

```json
{
  "deps": {
    "moonbitlang/async": "^0.10.4"
  }
}
```

2) åœ¨åŒ…çš„ `moon.pkg.json` ä¸­å¼•å…¥éœ€è¦çš„å­åŒ…ï¼š

```json
{
  "import": [
    "moonbitlang/async",
    "moonbitlang/async/semaphore",
    "moonbitlang/async/aqueue"
  ]
}
```

3) è¿è¡Œæµ‹è¯•ï¼ˆnative ç›®æ ‡ï¼‰ï¼š

```bash
moon test --target native
```

å¦‚ä»…æƒ³å¿«é€ŸæŸ¥çœ‹æŸä¸ªç”¨æ³•ï¼Œå¯ç›´æ¥æ‰“å¼€ `src/Async_best_practices.mbt` æœç´¢ç›¸åº”å‡½æ•°åã€‚

## æ ¸å¿ƒç¤ºä¾‹ï¼ˆæ–‡ä»¶ï¼š`src/Async_best_practices.mbt`ï¼‰

æœ¬æ–‡ä»¶åŒ…å« 25 ä¸ªå®Œæ•´ç¤ºä¾‹ï¼Œæ¶µç›–ä»å…¥é—¨åˆ°é«˜çº§çš„å„ç§å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼Œå…¶ä¸­æ–°å¢ 1 ä¸ªâ€œä¸‹å•+æ”¯ä»˜â€ä¸šåŠ¡ç»¼åˆåœºæ™¯ç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•åœ¨çœŸå®ä¸šåŠ¡æµç¨‹ä¸­ç»„åˆä½¿ç”¨é‡è¯•ä¸è¶…æ—¶ã€‚

### å…¥é—¨ç¤ºä¾‹ï¼ˆç¤ºä¾‹ 1-8ï¼‰

- ç®€å•å¼‚æ­¥å‡½æ•°ï¼š`hello_async`
- å¹¶å‘ä»»åŠ¡ï¼š`concurrent_tasks`
- è¶…æ—¶å¤„ç†ï¼š`timeout_example`
- é¡ºåºæµæ°´çº¿ï¼š`sequential_pipeline`
- ç«é€Ÿæ¨¡å¼ï¼š`race_example`
- é‡è¯•æœºåˆ¶ï¼š`retry_example`
- é”™è¯¯å¤„ç†ï¼š`error_handling_example`
- æ‰¹é‡å¤„ç†ï¼š`batch_processing`

### é«˜çº§ç¤ºä¾‹ï¼ˆç¤ºä¾‹ 9-25ï¼‰

- ç»“æ„åŒ–å¹¶å‘ï¼š`demo_spawn`
  - ä½¿ç”¨ `@async.with_task_group(fn(root) { ... })` ç®¡ç†ä»»åŠ¡ä½œç”¨åŸŸ
  - `root.spawn_bg` çš„â€œå³å‘å³å¼ƒâ€ä»»åŠ¡ä»å—å–æ¶ˆä¼ æ’­çº¦æŸ

- è¶…æ—¶ä¸å–æ¶ˆï¼š`demo_with_timeout`
  - ç”¨ `@async.with_timeout(ms, fn { ... })` ç»™å¼‚æ­¥é˜¶æ®µè®¾å®šä¸Šé™
  - å¤±è´¥/è¶…æ—¶è¦è®°å½•å¯è¡ŒåŠ¨ä¸Šä¸‹æ–‡ï¼Œä¾¿äºæ’éšœ

- å…³é”®åŒºé˜²å–æ¶ˆï¼š`demo_protect_from_cancel`
  - ç”¨äºæäº¤/å›æ»šã€æŒä¹…åŒ–æŒ‡æ ‡ã€èµ„æºäº¤æ¥ç­‰åŸå­é˜¶æ®µ
  - ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨ï¼Œå› å…¶ä¼šæ‰“ç ´å¤–å±‚è¶…æ—¶ç­‰æŠ½è±¡

- å¹¶å‘é™æµï¼ˆä¿¡å·é‡ï¼‰ï¼š`demo_semaphore`
  - ä¼˜å…ˆä½¿ç”¨ä¿¡å·é‡è€Œéè‡ªåˆ¶è®¡æ•°å™¨
  - å…³é”®åŒºåº”çŸ­å°ï¼šacquire â†’ work â†’ release

- é‡è¯•ç­–ç•¥ï¼š`demo_retry_fixed`
  - ä½¿ç”¨ `@async.retry(FixedDelay(...), fn { ... })` å®ç°â€œå›ºå®šé—´éš”+ä¸Šé™â€çš„é€€é¿

- å¯é€‰è¶…æ—¶ï¼š`demo_with_timeout_opt`
  - `@async.with_timeout_opt(ms, fn)` è¿”å› `Some(value)` æˆ– `None`ï¼Œä¾¿äºç›´æ¥åˆ†æ”¯

- é˜Ÿåˆ—/ç®¡é“ï¼š`demo_queue_pipeline`
  - ä½¿ç”¨ `@aqueue.Queue` æ„å»ºç”Ÿäº§è€…-æ¶ˆè´¹è€…æµæ°´çº¿
  - éé˜»å¡å†™ã€é˜»å¡è¯»ï¼ˆå¯è¢«å–æ¶ˆï¼‰ï¼Œå…ˆåˆ°å…ˆæœåŠ¡

æ–°å¢ç¤ºä¾‹ï¼š

- é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰ï¼š`demo_retry_exponential`
  - `@async.retry(ExponentialDelay(initial, factor, maximum), fn)`
  - å¯è§†åŒ– backoff æ—¶é—´çº¿ï¼Œé¿å…çƒ­å¾ªç¯

- ä¿¡å·é‡éé˜»å¡è·å–ï¼š`demo_semaphore_try_acquire`
  - ç”¨ `Semaphore.try_acquire()` èµ°â€œå¿«é€Ÿå¤±è´¥/é™çº§â€è·¯å¾„
  - ä¸é˜»å¡å¼ `acquire()` æ­é…ï¼Œæ„å»ºæ›´çµæ´»çš„é™æµ

- å¤šç”Ÿäº§è€…/å¤šæ¶ˆè´¹è€…é˜Ÿåˆ—ï¼š`demo_queue_mpmc`
  - 2P/2C çš„ FIFO æ¶ˆè´¹ï¼Œè¾“å‡ºå¯¹å€¼åºåˆ—æ–­è¨€è€Œéçº¿ç¨‹ ID

- ä»»åŠ¡å¥æŸ„ä¸ç­‰å¾…ï¼š`demo_task_wait_and_try_wait`
  - `Task::try_wait()` è·å–éé˜»å¡ç»“æœï¼›`Task::wait()` é˜»å¡ç›´åˆ°å®Œæˆ

- æŒç»­æœåŠ¡å¾ªç¯ï¼š`demo_spawn_loop_retry_exponential`
  - `root.spawn_loop(retry=ExponentialDelay(...), fn -> IterResult)`
  - åœ¨å¾ªç¯ä½“å†…è‡ªåŠ¨é‡è¯• + ä»¥ `IterEnd` é€€å‡º

- ç»„çº§æ¸…ç†ï¼š`demo_group_defer`
  - `TaskGroup::add_defer(async () -> Unit)` æä¾›ç»“æ„åŒ–æ¸…ç†
  - ä¸ `defer`ã€å–æ¶ˆä¼ æ’­åä½œï¼Œé¡ºåºå¯é¢„æµ‹ï¼ˆFILOï¼‰

- ä¸šåŠ¡ç»¼åˆåœºæ™¯ï¼š`demo_business_checkout_flow`
  - æ¨¡æ‹Ÿâ€œä¸‹å•+æ”¯ä»˜â€æµç¨‹ï¼Œç»„åˆä½¿ç”¨ `with_timeout_opt` ä¸ `retry(ExponentialDelay)`
  - å±•ç¤ºå¦‚ä½•æŠŠåŸºç¡€è®¾æ–½èƒ½åŠ›å°è£…è¿›ä¸šåŠ¡æµç¨‹

è¿è¡Œè¿™äº›ç¤ºä¾‹çš„æµ‹è¯•å¯ç›´è§‚çœ‹åˆ°äº‹ä»¶æ—¶é—´çº¿ä¸é¢„æœŸè¾“å‡ºã€‚

## è¿è¡Œä¸æ›´æ–°å¿«ç…§

- è¿è¡Œï¼š`moon test --target native`
- è¡Œä¸ºå˜æ›´åæ›´æ–°å¿«ç…§ï¼š`moon test --target native --update`

- å¼€å‘å¸¸ç”¨ï¼š`moon info && moon fmt` æ›´æ–°æ¥å£ä¸æ ¼å¼åŒ–ä»£ç 
- è´¨é‡æ£€æŸ¥ï¼š`moon check` é™æ€æ£€æŸ¥ï¼›`moon coverage analyze > uncovered.log` æŸ¥çœ‹è¦†ç›–ç‡è–„å¼±ç‚¹

## ç›®æ ‡è¯´æ˜

- ä¸Šæ¸¸ `moonbitlang/async` å†…éƒ¨ä½¿ç”¨ C FFIï¼Œ`wasm-gc` ç›®å‰ä¸æ”¯æŒ
- æ¨è `--target native`ï¼›å¦‚éœ€ `--target wasm/js`ï¼Œè¯·æŒ‰éœ€æ›¿æ¢ä¾èµ–

## å‘å¸ƒåˆ° Mooncakesï¼ˆå¯é€‰ï¼‰

è‹¥ä½  fork/æ”¹é€ äº†æœ¬ä»“åº“ï¼Œå¸Œæœ›ä»¥æ¨¡å—å½¢å¼åˆ†å‘ï¼š

1) ä¿®æ”¹ `moon.mod.json`ï¼š

```json
{
  "name": "yourname/async-best-practices",
  "repository": "https://github.com/yourname/async-best-practices"
}
```

2) ç¡®ä¿ `README.mbt.md` ä¸ºå…¥å£æ–‡æ¡£ï¼ˆæœ¬ä»“åº“å·²é…ç½® `readme` å­—æ®µï¼‰ã€‚

3) åœ¨ Mooncakes é…ç½®å‡­æ®åï¼Œæ‰§è¡Œå‘å¸ƒå‘½ä»¤ï¼ˆä»¥å®˜æ–¹æŒ‡å—ä¸ºå‡†ï¼‰ï¼Œé€šå¸¸ä¸ºï¼š

```bash
moon publish
```

æ³¨æ„ï¼š`name` å‰ç¼€éœ€ä¸ºä½ çš„ Mooncakes ç”¨æˆ·åï¼›å»ºè®®ä»“åº“åå’Œæ¨¡å—åä½¿ç”¨å°å†™è¿å­—ç¬¦é£æ ¼ã€‚

## è¿›ä¸€æ­¥é˜…è¯»

- æŸ¥çœ‹ `src/Async_best_practices.mbt` ä»¥å­¦ä¹ ç´§å‡‘çš„æƒ¯ç”¨å†™æ³•
- å‚è€ƒä¸Šæ¸¸ `.mooncakes/moonbitlang/async/` ä¸­æ›´é«˜çº§çš„ IO/HTTP/è¿›ç¨‹æ§åˆ¶ç¤ºä¾‹ä¸æ–‡æ¡£
- é˜…è¯» `docs/best_practices.mbt.md` äº†è§£è¯¦ç»†çš„è®¾è®¡ç†å¿µä¸æœ€ä½³å®è·µ
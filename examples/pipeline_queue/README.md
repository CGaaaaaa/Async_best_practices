## examples/pipeline_queue â€” ç”Ÿäº§è€…-æ¶ˆè´¹è€…æµæ°´çº¿

> **æ¨èé˜…è¯»é¡ºåºï¼šç¬¬ 5 ä¸ª**ï¼ˆç†è§£é˜Ÿåˆ—ä¸èƒŒå‹ï¼‰

---

## æ ¸å¿ƒçŸ¥è¯†ç‚¹

- âœ… **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼**ï¼šç”¨ `aqueue.Queue` è§£è€¦ç”Ÿäº§ä¸æ¶ˆè´¹
- âœ… **å¹¶è¡Œæ¶ˆè´¹**ï¼šå¤šä¸ª worker å¹¶è¡Œå¤„ç†æ•°æ®
- âœ… **èƒŒå‹æœºåˆ¶**ï¼šç”¨ Semaphore æ§åˆ¶é˜Ÿåˆ—å¤§å°ï¼ˆé˜²æ­¢å†…å­˜çˆ†ç‚¸ï¼‰

---

## åœºæ™¯è¯´æ˜

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºï¼š
1. å¦‚ä½•ç”¨ `aqueue.Queue` æ„å»ºç”Ÿäº§è€…-æ¶ˆè´¹è€…æµæ°´çº¿
2. å¤šä¸ª worker å¹¶è¡Œæ¶ˆè´¹æ•°æ®
3. æ±‡æ€»æ‰€æœ‰ worker çš„ç»“æœ

**ä¸ºä»€ä¹ˆéœ€è¦é˜Ÿåˆ—ï¼Ÿ**
- **è§£è€¦ç”Ÿäº§ä¸æ¶ˆè´¹**ï¼šç”Ÿäº§è€…ä¸éœ€è¦ç­‰å¾…æ¶ˆè´¹è€…å¤„ç†å®Œ
- **å‰Šå³°å¡«è°·**ï¼šç”Ÿäº§é€Ÿåº¦æ³¢åŠ¨æ—¶ï¼Œé˜Ÿåˆ—èµ·ç¼“å†²ä½œç”¨
- **å¹¶è¡Œå¤„ç†**ï¼šå¤šä¸ª worker å¹¶è¡Œæ¶ˆè´¹ï¼Œæå‡ååé‡

**çœŸå®åœºæ™¯**ï¼š
- çˆ¬è™«æŠ“å– URLï¼Œå¤šä¸ª worker å¹¶è¡Œè§£æå†…å®¹
- æ—¥å¿—æ”¶é›†ï¼Œå¤šä¸ª worker å¹¶è¡Œå†™å…¥ DB
- å›¾ç‰‡å¤„ç†ï¼Œå¤šä¸ª worker å¹¶è¡Œå‹ç¼©/ä¸Šä¼ 

---

## ä»£ç ç»“æ„

```
examples/pipeline_queue/
â”œâ”€â”€ README.mbt.md         # æœ¬æ–‡æ¡£
â”œâ”€â”€ pipeline.mbt          # æµæ°´çº¿ç¤ºä¾‹
â”œâ”€â”€ pipeline_test.mbt     # ç»“æœéªŒè¯æµ‹è¯•
â””â”€â”€ moon.pkg.json         # åŒ…é…ç½®
```

---

## å…³é”®ä»£ç è§£æ

### ç¤ºä¾‹ä»£ç ï¼ˆpipeline.mbtï¼‰

```moonbit
pub async fn pipeline_sum(n_items : Int, workers : Int) -> Int {
  @async.with_task_group(fn(group) {
    let q = @aqueue.Queue::new()  // âœ… åˆ›å»ºé˜Ÿåˆ—
    let total_sum = @ref.new(0)

    // Producerï¼šç”Ÿäº§ 1..n_items
    group.spawn_bg(fn() {
      for i in 1..(n_items + 1) {
        q.put(i)
      }
      // å‘é€ç»ˆæ­¢ä¿¡å·
      for _ in 0..<workers {
        q.put(0)  // 0 è¡¨ç¤ºç»“æŸ
      }
    })

    // Consumersï¼šå¤šä¸ª worker å¹¶è¡Œæ¶ˆè´¹
    let tasks = Array::new()
    for _ in 0..<workers {
      tasks.push(group.spawn(fn() -> Int raise {
        let mut acc = 0
        for {
          let v = q.get()  // âœ… é˜»å¡è·å–æ•°æ®
          guard v != 0 else { break }  // æ”¶åˆ°ç»ˆæ­¢ä¿¡å·
          acc = acc + v
        }
        acc
      }))
    }

    // Aggregateï¼šæ±‡æ€»æ‰€æœ‰ worker çš„ç»“æœ
    let mut sum = 0
    for task in tasks {
      sum = sum + task.wait()
    }
    sum
  })
}
```

**å…³é”®ç‚¹**ï¼š
1. **ç”Ÿäº§è€…**ï¼šç”¨ `q.put(item)` æ”¾å…¥æ•°æ®
2. **ç»ˆæ­¢ä¿¡å·**ï¼šç”¨ç‰¹æ®Šå€¼ï¼ˆ0ï¼‰é€šçŸ¥ worker é€€å‡º
3. **æ¶ˆè´¹è€…**ï¼šç”¨ `q.get()` é˜»å¡è·å–æ•°æ®
4. **å¹¶è¡Œå¤„ç†**ï¼šå¤šä¸ª worker åŒæ—¶ä»é˜Ÿåˆ—å–æ•°æ®
5. **ç»“æœæ±‡æ€»**ï¼šç”¨ `task.wait()` è·å–æ¯ä¸ª worker çš„ç»“æœ

### æµ‹è¯•ä»£ç ï¼ˆpipeline_test.mbtï¼‰

```moonbit
async test "pipeline_sum_flow" {
  let out = pipeline_sum(10, 3)  // 10 ä¸ªæ•°å­—ï¼Œ3 ä¸ª worker
  inspect(out, content=(#|55|))  // 1+2+...+10 = 55
}
```

**éªŒè¯**ï¼š
- ç”Ÿäº§è€…ç”Ÿæˆ 1, 2, 3, ..., 10
- 3 ä¸ª worker å¹¶è¡Œå¤„ç†ï¼Œæ¯ä¸ª worker ç´¯åŠ ä¸€éƒ¨åˆ†æ•°å­—
- æœ€ç»ˆç»“æœæ˜¯æ‰€æœ‰æ•°å­—çš„æ€»å’Œï¼š55

---

## å·¥ä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Producer    â”‚
â”‚  (ç”Ÿæˆ 1..10) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ put(1), put(2), ...
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Queue      â”‚
â”‚ [1, 2, 3...] â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ get()
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â†“            â†“            â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚Worker 1â”‚  â”‚Worker 2â”‚  â”‚Worker 3â”‚
  â”‚ (ç´¯åŠ ) â”‚  â”‚ (ç´¯åŠ ) â”‚  â”‚ (ç´¯åŠ ) â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚           â”‚           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Aggregate   â”‚
            â”‚  (æ±‡æ€»ç»“æœ)   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åæ¨¡å¼ï¼šæ— ç•Œé˜Ÿåˆ— + æ— é™ç”Ÿäº§

### åæ¨¡å¼ âŒ

```moonbit
async fn bad_pipeline() {
  let queue = @aqueue.Queue::new()
  
  @async.with_task_group(fn(group) {
    // âŒ ç”Ÿäº§è€…æ— é™ putï¼Œæ¶ˆè´¹è€…å¤„ç†æ…¢æ—¶å†…å­˜çˆ†ç‚¸
    group.spawn_bg(fn() {
      for i in 0..<1_000_000 {
        queue.put(i)  // å†…å­˜æŒç»­å¢é•¿
      }
    })
    
    // æ¶ˆè´¹è€…å¤„ç†æ…¢
    group.spawn_bg(fn() {
      for {
        let item = queue.get()
        @async.sleep(100)  // æ¯ä¸ªä»»åŠ¡ 100ms
      }
    })
  })
}
```

**é—®é¢˜**ï¼š
- ç”Ÿäº§é€Ÿåº¦ >> æ¶ˆè´¹é€Ÿåº¦ï¼Œé˜Ÿåˆ—å †ç§¯ 100 ä¸‡æ¡æ•°æ®
- å†…å­˜è€—å°½ï¼ˆOOMï¼‰

### æ­£ä¾‹ï¼šç”¨ Semaphore æ§åˆ¶é˜Ÿåˆ—å¤§å° âœ…

```moonbit
async fn good_pipeline() {
  let queue = @aqueue.Queue::new()
  let sem = @semaphore.Semaphore::new(100)  // âœ… æœ€å¤š 100 æ¡æ•°æ®åœ¨é˜Ÿåˆ—ä¸­
  
  @async.with_task_group(fn(group) {
    // ç”Ÿäº§è€…ï¼šç”¨ Semaphore æ§åˆ¶é€Ÿåº¦
    group.spawn_bg(fn() raise {
      for i in 0..<1_000_000 {
        sem.acquire()  // é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…é˜»å¡
        queue.put(i)
      }
      queue.put(-1)  // ç»ˆæ­¢ä¿¡å·
    })
    
    // æ¶ˆè´¹è€…
    group.spawn_bg(fn() {
      for {
        let item = queue.get()
        guard item != -1 else { break }
        process(item)
        sem.release()  // å¤„ç†å®Œåé‡Šæ”¾æ§½ä½
      }
    })
  })
}
```

**å¥½å¤„**ï¼š
- é˜Ÿåˆ—æœ€å¤š 100 æ¡æ•°æ®ï¼Œå†…å­˜å¯æ§
- ç”Ÿäº§é€Ÿåº¦è‡ªåŠ¨åŒ¹é…æ¶ˆè´¹é€Ÿåº¦ï¼ˆèƒŒå‹ï¼‰

---

## è¿è¡Œç¤ºä¾‹

### è¿è¡Œæµ‹è¯•

```bash
cd examples/pipeline_queue
moon test --target native
```

**é¢„æœŸè¾“å‡º**ï¼š
```
Finished. moon: no work to do
Total tests: 1, passed: 1, failed: 0.
```

### ä¿®æ”¹ç¤ºä¾‹ï¼šè§‚å¯Ÿä¸åŒ worker æ•°é‡

å°è¯•ä¿®æ”¹ worker æ•°é‡ï¼š

```moonbit
async test "pipeline_sum_flow" {
  let out = pipeline_sum(100, 10)  // 100 ä¸ªæ•°å­—ï¼Œ10 ä¸ª worker
  inspect(out, content=(#|5050|))  // 1+2+...+100 = 5050
}
```

**è§‚å¯Ÿ**ï¼š
- worker è¶Šå¤šï¼Œå¹¶è¡Œåº¦è¶Šé«˜ï¼ˆç†è®ºä¸Šæ›´å¿«ï¼‰
- ä½†å®é™…æ€§èƒ½å—é˜Ÿåˆ—ç«äº‰å½±å“

---

## å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ

å®Œæˆè¿™ä¸ªç¤ºä¾‹åï¼Œä½ åº”è¯¥ç†è§£ï¼š

1. **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼**
   - ç”¨ `aqueue.Queue` è§£è€¦ç”Ÿäº§ä¸æ¶ˆè´¹
   - ç”¨ç‰¹æ®Šå€¼ï¼ˆä¾‹å¦‚ 0 æˆ– -1ï¼‰ä½œä¸ºç»ˆæ­¢ä¿¡å·

2. **å¹¶è¡Œæ¶ˆè´¹**
   - å¤šä¸ª worker å¹¶è¡Œä»é˜Ÿåˆ—å–æ•°æ®
   - ç”¨ `task.wait()` æ±‡æ€»æ‰€æœ‰ worker çš„ç»“æœ

3. **èƒŒå‹æœºåˆ¶**
   - `aqueue.Queue` æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œéœ€è¦æ‰‹åŠ¨æ§åˆ¶å¤§å°
   - ç”¨ Semaphore é™åˆ¶é˜Ÿåˆ—å¤§å°ï¼Œé˜²æ­¢å†…å­˜çˆ†ç‚¸

---

## ä¸‹ä¸€æ­¥

æ­å–œï¼ä½ å·²ç»å®Œæˆäº†æ‰€æœ‰ç¤ºä¾‹ã€‚æ¥ä¸‹æ¥å¯ä»¥ï¼š

1. **å¯¹ç…§ PR æ£€æŸ¥æ¸…å•**ï¼š`docs/best_practices.mbt.md`
2. **æŸ¥é˜…å®Œæ•´ API æ‰‹å†Œ**ï¼š`src/Async_best_practices.mbt`
3. **é›†æˆåˆ°ä½ çš„é¡¹ç›®**ï¼šå¤åˆ¶ `infra/` æ¨¡æ¿

---

## å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆç”¨ç‰¹æ®Šå€¼ï¼ˆ0ï¼‰ä½œä¸ºç»ˆæ­¢ä¿¡å·ï¼Ÿ

**A**ï¼š
- `aqueue.Queue` æ²¡æœ‰å†…ç½®çš„"å…³é—­"æœºåˆ¶
- ç”¨ç‰¹æ®Šå€¼ï¼ˆ0ã€-1ã€ç©ºå­—ç¬¦ä¸²ç­‰ï¼‰é€šçŸ¥ worker é€€å‡º
- ç”Ÿäº§è€…éœ€è¦ç»™æ¯ä¸ª worker å‘é€ä¸€æ¬¡ç»ˆæ­¢ä¿¡å·

### Q2ï¼šå¦‚ä½•å¤„ç†æœ‰ç•Œé˜Ÿåˆ—ï¼Ÿ

**A**ï¼šMoonBit çš„ `aqueue.Queue` æ˜¯æ— ç•Œé˜Ÿåˆ—ã€‚å¦‚æœéœ€è¦æœ‰ç•Œé˜Ÿåˆ—ï¼š
- ç”¨ Semaphore æ§åˆ¶é˜Ÿåˆ—å¤§å°ï¼ˆè§ä¸Šæ–‡"æ­£ä¾‹"ï¼‰
- ç”Ÿäº§è€…åœ¨ `put` å‰ `acquire()`ï¼Œæ¶ˆè´¹è€…åœ¨ `get` å `release()`

### Q3ï¼šå¦‚ä½•å¤„ç†å¼‚å¸¸ï¼ˆworker å¤±è´¥ï¼‰ï¼Ÿ

**A**ï¼š
- ç”¨ `try...catch` æ•è·å¼‚å¸¸ï¼š

```moonbit
tasks.push(group.spawn(fn() -> Int raise {
  let mut acc = 0
  for {
    let v = q.get()
    guard v != 0 else { break }
    (fn() { acc = acc + process(v) })() catch {
      err => log("worker error: {err}")  // è®°å½•é”™è¯¯ï¼Œç»§ç»­å¤„ç†
    }
  }
  acc
}))
```

### Q4ï¼šå¦‚ä½•ç›‘æ§é˜Ÿåˆ—é•¿åº¦ï¼Ÿ

**A**ï¼šéœ€è¦æ‰‹åŠ¨è®¡æ•°ï¼š

```moonbit
let queue_size = @ref.new(0)

// ç”Ÿäº§è€…
queue_size.val = queue_size.val + 1
q.put(item)

// æ¶ˆè´¹è€…
q.get()
queue_size.val = queue_size.val - 1
```

---

**æŒæ¡é˜Ÿåˆ—ä¸æµæ°´çº¿åï¼Œä½ å¯ä»¥æ„å»ºé«˜ååé‡çš„å¼‚æ­¥ç³»ç»Ÿï¼** ğŸš€


## examples/checkout â€” æœ€å°ä¸šåŠ¡é—­ç¯ç¤ºä¾‹

> **æ¨èé˜…è¯»é¡ºåºï¼šç¬¬ 1 ä¸ª**ï¼ˆ10 åˆ†é’Ÿä¸Šæ‰‹ï¼‰

---

## æ ¸å¿ƒçŸ¥è¯†ç‚¹

- âœ… **ä¸šåŠ¡ä¸ infra åˆ†å±‚**ï¼šä¸šåŠ¡ä»£ç åªå¤„ç† `Result`ï¼Œç­–ç•¥åœ¨ `infra` ç»Ÿä¸€
- âœ… **å¿«ç…§æµ‹è¯•**ï¼šç”¨ `inspect` éªŒè¯å®Œæ•´è¾“å‡º
- âœ… **é”™è¯¯å¤„ç†**ï¼šå±•ç¤ºæˆåŠŸ/å¤±è´¥ä¸¤ç§è·¯å¾„

---

## åœºæ™¯è¯´æ˜

è¿™æ˜¯ä¸€ä¸ª**æç®€çš„è®¢å•ç»“ç®—æµç¨‹**ï¼š
1. éå†è®¢å•åˆ—è¡¨
2. å¯¹æ¯ä¸ªè®¢å•è°ƒç”¨æ”¯ä»˜æ¥å£ï¼ˆé€šè¿‡ `@infra` å°è£…ï¼‰
3. æ ¹æ®ç»“æœè®°å½•æ—¥å¿—

**ä¸ºä»€ä¹ˆä»è¿™ä¸ªç¤ºä¾‹å¼€å§‹ï¼Ÿ**
- ä»£ç é‡å°‘ï¼ˆ< 20 è¡Œï¼‰
- å±•ç¤ºäº†æœ€æ ¸å¿ƒçš„æ¨¡å¼ï¼šä¸šåŠ¡å±‚ä¸å…³å¿ƒ"æ€ä¹ˆè°ƒç”¨"ï¼Œåªå¤„ç† `Result`
- æµ‹è¯•ç®€å•ï¼Œä¸€çœ¼çœ‹æ‡‚

---

## ä»£ç ç»“æ„

```
examples/checkout/
â”œâ”€â”€ README.mbt.md         # æœ¬æ–‡æ¡£
â”œâ”€â”€ checkout.mbt          # ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ checkout_test.mbt     # å¿«ç…§æµ‹è¯•
â””â”€â”€ moon.pkg.json         # åŒ…é…ç½®
```

---

## å…³é”®ä»£ç è§£æ

### ä¸šåŠ¡å±‚ä»£ç ï¼ˆcheckout.mbtï¼‰

```moonbit
pub async fn checkout_orders(order_ids : Array[Int]) -> String {
  let log = StringBuilder::new()
  for id in order_ids {
    log.write_string("start order \{id}\n")
    
    // âœ… ä¸šåŠ¡å±‚åªè°ƒç”¨ infra wrapperï¼Œä¸å…³å¿ƒè¶…æ—¶/é‡è¯•ç»†èŠ‚
    let outcome = @infra.call_payment_with_retry(id)
    
    match outcome {
      Ok(_) => log.write_string("order \{id} success\n")
      Err(e) => log.write_string("order \{id} failed: \{e}\n")
    }
  }
  log.to_string()
}
```

**å…³é”®ç‚¹**ï¼š
1. **èŒè´£å•ä¸€**ï¼šä¸šåŠ¡ä»£ç åªè¡¨è¾¾"å¤„ç†è®¢å•åˆ—è¡¨ï¼Œè®°å½•ç»“æœ"
2. **ç­–ç•¥åˆ†ç¦»**ï¼šè¶…æ—¶ 500msã€é‡è¯• 3 æ¬¡ç­‰ç­–ç•¥éƒ½åœ¨ `infra/clients.mbt` ä¸­
3. **è¿”å›ç®€å•ç±»å‹**ï¼šè¿”å› `String`ï¼ˆæ—¥å¿—ï¼‰ï¼Œæ–¹ä¾¿æµ‹è¯•

### æµ‹è¯•ä»£ç ï¼ˆcheckout_test.mbtï¼‰

```moonbit
async test "checkout_orders_flow" {
  let out = checkout_orders([101, 102])
  inspect(
    out,
    content=(
      #|start order 101
      #|order 101 success
      #|start order 102
      #|order 102 success
      #|
    ),
  )
}
```

**å…³é”®ç‚¹**ï¼š
1. **å¿«ç…§æµ‹è¯•**ï¼šç”¨ `inspect` éªŒè¯å®Œæ•´è¾“å‡ºï¼ˆä¸åªæ˜¯æŸä¸ªå­—æ®µï¼‰
2. **ç¨³å®šå¤ç°**ï¼šorder 101/102 çš„è¡Œä¸ºç”± `infra/clients.mbt` æ¨¡æ‹Ÿï¼Œ100% å¯å¤ç°
3. **å¯è¯»æ€§å¼º**ï¼šä¸€çœ¼çœ‹æ‡‚é¢„æœŸè¡Œä¸º

---

## ä¾èµ–å…³ç³»

```
checkout.mbt
    â†“
@infra.call_payment_with_retry(...)  â† infra/clients.mbt
    â†“
call_with_timeout_and_retry(500, ...)  â† ç»Ÿä¸€è¶…æ—¶/é‡è¯•ç­–ç•¥
    â†“
@async.with_timeout_opt(...)           â† moonbitlang/async
@async.retry(ExponentialDelay(...))
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**
- ä¸šåŠ¡å±‚ä¸éœ€è¦çŸ¥é“è¶…æ—¶æ˜¯ 500ms è¿˜æ˜¯ 1s
- å°†æ¥è¦æ”¹è¶…æ—¶å‚æ•°ï¼Œåªéœ€ä¿®æ”¹ `infra/clients.mbt`
- æµ‹è¯•æ—¶å¯ä»¥ mock `@infra`ï¼Œä¸éœ€è¦çœŸå® sleep

---

## è¿è¡Œç¤ºä¾‹

### è¿è¡Œæµ‹è¯•

```bash
cd examples/checkout
moon test --target native
```

**é¢„æœŸè¾“å‡º**ï¼š
```
Finished. moon: no work to do
Total tests: 1, passed: 1, failed: 0.
```

### ä¿®æ”¹ç¤ºä¾‹

å°è¯•ä¿®æ”¹è®¢å• IDï¼Œè§‚å¯Ÿä¸åŒè¡Œä¸ºï¼š

```moonbit
// ä¿®æ”¹ checkout_test.mbt
async test "checkout_orders_flow" {
  let out = checkout_orders([101, 102, 999])  // 999 æ˜¯ä»€ä¹ˆè¡Œä¸ºï¼Ÿ
  inspect(out, content=(...))
}
```

**æç¤º**ï¼šæŸ¥çœ‹ `infra/clients.mbt` çš„ `call_payment_with_retry` å®ç°ï¼Œäº†è§£ä¸åŒ order_id çš„æ¨¡æ‹Ÿè¡Œä¸ºã€‚

---

## å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ

å®Œæˆè¿™ä¸ªç¤ºä¾‹åï¼Œä½ åº”è¯¥ç†è§£ï¼š

1. **ä¸šåŠ¡ä¸ infra åˆ†å±‚**
   - ä¸šåŠ¡ä»£ç ï¼šåªè°ƒç”¨ `@infra.xxx`ï¼Œå¤„ç† `Result`
   - infra ä»£ç ï¼šå°è£…è¶…æ—¶/é‡è¯•/é”™è¯¯å½’ä¸€åŒ–

2. **å¿«ç…§æµ‹è¯•**
   - ç”¨ `inspect` éªŒè¯å®Œæ•´è¾“å‡º
   - ä¸éœ€è¦çœŸå®å¤–éƒ¨æœåŠ¡ï¼Œæµ‹è¯• 100% å¯å¤ç°

3. **ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**
   - ç­–ç•¥é›†ä¸­ï¼šä¿®æ”¹è¶…æ—¶å‚æ•°æ—¶ä¸ç”¨æ”¹ä¸šåŠ¡ä»£ç 
   - æ˜“äºæµ‹è¯•ï¼šä¸šåŠ¡å±‚æµ‹è¯• mock `infra`ï¼Œä¸éœ€è¦ sleep

---

## ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹ æ›´å¤æ‚çš„æ¨¡å¼ï¼š

- **[examples/task_group](../task_group/)**ï¼šç»“æ„åŒ–å¹¶å‘ä¸å–æ¶ˆä¼ æ’­
- **[examples/retry_timeout](../retry_timeout/)**ï¼šè¶…æ—¶/é‡è¯•çš„è¯¦ç»†åœºæ™¯

---

## å¸¸è§é—®é¢˜

### Q1ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨ä¸šåŠ¡ä»£ç ä¸­è°ƒç”¨ `@async.with_timeout_opt`ï¼Ÿ

**A**ï¼š
- ä¸šåŠ¡ä»£ç ä¼šæ•£è½å¤§é‡è¶…æ—¶å‚æ•°ï¼ˆéš¾ä»¥ç»Ÿä¸€è°ƒæ•´ï¼‰
- ä»£ç å®¡æŸ¥æ—¶éœ€è¦é€ä¸ªæ£€æŸ¥æ¯ä¸ªæ–‡ä»¶
- æµ‹è¯•æ—¶éœ€è¦çœŸå® sleepï¼ˆæ…¢ã€ä¸ç¨³å®šï¼‰

### Q2ï¼š`call_payment_with_retry` æ˜¯çœŸå®çš„æ”¯ä»˜è°ƒç”¨å—ï¼Ÿ

**A**ï¼š
- è¿™æ˜¯æ•™å­¦ç¤ºä¾‹ï¼Œç”¨è®¡æ•°å™¨æ¨¡æ‹Ÿç¬æ€å¤±è´¥
- çœŸå®é¡¹ç›®åº”æ›¿æ¢ä¸ºçœŸå® HTTP/RPC è°ƒç”¨
- æ¨¡æ‹Ÿè¡Œä¸ºè§ `infra/clients.mbt`

### Q3ï¼šå¦‚ä½•æµ‹è¯•å¤±è´¥åœºæ™¯ï¼Ÿ

**A**ï¼š
```moonbit
async test "checkout_orders_with_failure" {
  // æ·»åŠ ä¼šå¤±è´¥çš„ order_idï¼ˆéœ€è¦æŸ¥çœ‹ infra å®ç°ï¼‰
  let out = checkout_orders([101, 999])
  inspect(out, content=(...))
}
```

---

**å®Œæˆè¿™ä¸ªç¤ºä¾‹åï¼Œä½ å·²ç»ç†è§£äº† Async çš„æ ¸å¿ƒæ¨¡å¼ï¼ç»§ç»­æ¢ç´¢æ›´å¤šåœºæ™¯å§ï¼** ğŸš€


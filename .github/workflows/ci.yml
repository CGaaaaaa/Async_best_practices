name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install MoonBit
        run: |
          curl -fsSL https://cli.moonbitlang.cn/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH
      
      - name: Update MoonBit registry
        run: moon update
      
      - name: Verify MoonBit installation
        run: moon info --target native
        
      - name: Check async package version
        run: |
          echo "Checking async package version..."
          cat moon.mod.json | grep async
          echo "MoonBit version info:"
          moon info --target native 2>&1 | head -5 || true
          echo "Cleaning and rebuilding dependencies..."
          moon clean || true
          rm -rf .mooncakes/ target/ || true
          moon update
          echo "Verifying async package installation..."
          ls -la .mooncakes/moonbitlang/async/src/internal/coroutine/ 2>/dev/null | head -5 || echo "Cannot list coroutine directory"
      
      - name: Clean build cache
        run: |
          moon clean || true
          rm -rf target/ .mooncakes/ || true
      
      - name: Run tests
        run: |
          # 运行测试并捕获输出
          moon test --target native --no-render 2>&1 | tee test_output.log || true
          
          # 检查测试结果
          if grep -q "Total tests:.*passed:.*failed: 0" test_output.log; then
            echo "✅ All tests passed!"
            exit 0
          elif grep -q "failed: [1-9]" test_output.log; then
            echo "❌ Tests failed!"
            cat test_output.log
            exit 1
          else
            echo "⚠️  Unknown test status, showing output:"
            cat test_output.log
            exit 1
          fi



# API è¦†ç›–ç‡æŠ¥å‘Š

æœ¬æŠ¥å‘Šåˆ†æ `Async_best_practices` é¡¹ç›®å¯¹ `moonbitlang/async` åº“çš„ API è¦†ç›–æƒ…å†µã€‚

ç”Ÿæˆæ—¶é—´ï¼š2025-11-06

---

## ğŸ“Š æ€»ä½“è¦†ç›–ç‡

| ç±»åˆ« | å·²è¦†ç›– | æ€»æ•° | è¦†ç›–ç‡ |
|------|--------|------|--------|
| **æ ¸å¿ƒ API** | 10 | 10 | **100%** âœ… |
| **TaskGroup æ–¹æ³•** | 6 | 6 | **100%** âœ… |
| **Task æ–¹æ³•** | 3 | 3 | **100%** âœ… |
| **Queue æ–¹æ³•** | 4 | 4 | **100%** âœ… |
| **Semaphore æ–¹æ³•** | 4 | 4 | **100%** âœ… |
| **é”™è¯¯ç±»å‹** | 1 | 1 | **100%** âœ… |
| **æ•´ä½“è¦†ç›–ç‡** | **28** | **28** | **100%** ğŸ‰ |

**ç»“è®ºï¼šå·²è¾¾æˆ 100% å®Œæ•´è¦†ç›–ç‡ï¼** ğŸ‰ğŸ¯

---

## è¯¦ç»†è¦†ç›–æƒ…å†µ

### 1. æ ¸å¿ƒ Async API (10/10 = 100%) âœ…

| API | çŠ¶æ€ | ç¤ºä¾‹ä½ç½® |
|-----|------|----------|
| `sleep(Int)` | âœ… | å‡ ä¹æ‰€æœ‰ç¤ºä¾‹ |
| `pause()` | âœ… | ç¤ºä¾‹ 24: `demo_polling_pattern` |
| `with_task_group()` | âœ… | ç¤ºä¾‹ 2, 9-24 |
| `with_timeout()` | âœ… | ç¤ºä¾‹ 10, 12, 21 |
| `with_timeout_opt()` | âœ… | ç¤ºä¾‹ 3, 13 |
| `protect_from_cancel()` | âœ… | ç¤ºä¾‹ 12 |
| `retry()` (ä¸‰ç§ç­–ç•¥) | âœ… | ç¤ºä¾‹ 6, 13, 15, 20 |
| - `Immediate` | âœ… | ç¤ºä¾‹ 20 |
| - `FixedDelay` | âœ… | ç¤ºä¾‹ 13 |
| - `ExponentialDelay` | âœ… | ç¤ºä¾‹ 15 |
| `now()` | âœ… | ç¤ºä¾‹ 23: `demo_benchmark_example` |

### 2. TaskGroup æ–¹æ³• (6/6 = 100%) âœ…

| æ–¹æ³• | çŠ¶æ€ | ç¤ºä¾‹ä½ç½® |
|------|------|----------|
| `spawn()` | âœ… | ç¤ºä¾‹ 2, 14 |
| `spawn_bg()` | âœ… | ç¤ºä¾‹ 9, 10, 11, 16, 17 |
| `spawn_loop()` | âœ… | ç¤ºä¾‹ 14, 24 |
| `return_immediately()` | âœ… | ç¤ºä¾‹ 5, 14 |
| `add_defer()` | âœ… | ç¤ºä¾‹ 16, 18, 22 |
| `wait` (éšå¼) | âœ… | æ‰€æœ‰ `with_task_group` |

### 3. Task æ–¹æ³• (3/3 = 100%) âœ…

| æ–¹æ³• | çŠ¶æ€ | ç¤ºä¾‹ä½ç½® |
|------|------|----------|
| `wait()` | âœ… | ç¤ºä¾‹ 2, 14 |
| `try_wait()` | âœ… | ç¤ºä¾‹ 17 |
| `cancel()` | âœ… | ç¤ºä¾‹ 18 |

### 4. Queue (aqueue) æ–¹æ³• (4/4 = 100%) âœ…

| æ–¹æ³• | çŠ¶æ€ | ç¤ºä¾‹ä½ç½® | å¤‡æ³¨ |
|------|------|----------|------|
| `new()` | âœ… | ç¤ºä¾‹ 14, 17, 24 | - |
| `put()` | âœ… | ç¤ºä¾‹ 14, 17, 24 | - |
| `get()` | âœ… | ç¤ºä¾‹ 14, 17 | - |
| `try_get()` | âœ… | ç¤ºä¾‹ 24 | éé˜»å¡é˜Ÿåˆ—è¯»å– |

**è¯´æ˜ï¼š** æ‰€æœ‰ Queue API å‡å·²è¦†ç›–ï¼ŒåŒ…æ‹¬éé˜»å¡çš„ `try_get()` æ–¹æ³•ï¼ˆç¤ºä¾‹ 24ï¼‰ã€‚

### 5. Semaphore æ–¹æ³• (4/4 = 100%) âœ…

| æ–¹æ³• | çŠ¶æ€ | ç¤ºä¾‹ä½ç½® | å¤‡æ³¨ |
|------|------|----------|------|
| `new()` | âœ… | ç¤ºä¾‹ 11, 16, 17 | - |
| `acquire()` | âœ… | ç¤ºä¾‹ 11, 16 | - |
| `release()` | âœ… | ç¤ºä¾‹ 11, 16, 17 | - |
| `try_acquire()` | âœ… | ç¤ºä¾‹ 17 | éé˜»å¡ä¿¡å·é‡è·å– |

**è¯´æ˜ï¼š** æ‰€æœ‰ Semaphore API å‡å·²è¦†ç›–ï¼ŒåŒ…æ‹¬éé˜»å¡çš„ `try_acquire()` æ–¹æ³•ï¼ˆç¤ºä¾‹ 17ï¼‰ã€‚

### 6. é”™è¯¯ç±»å‹ (1/1 = 100%) âœ…

| é”™è¯¯ç±»å‹ | çŠ¶æ€ | ç¤ºä¾‹ä½ç½® |
|---------|------|----------|
| `TimeoutError` | âœ… | ç¤ºä¾‹ 20, 21 |
| `AlreadyTerminated` | N/A | (å·²åºŸå¼ƒ) |

---

## ğŸ“ˆ ç¤ºä¾‹è¦†ç›–åˆ†å¸ƒ

### æŒ‰éš¾åº¦åˆ†ç±»

- **å…¥é—¨ç¤ºä¾‹ (8ä¸ª)**ï¼šåŸºç¡€ API ä½¿ç”¨
  - ç¤ºä¾‹ 1-8
  - è¦†ç›–ç‡ï¼š100% æ ¸å¿ƒåŠŸèƒ½

- **é«˜çº§ç¤ºä¾‹ (16ä¸ª)**ï¼šå¤æ‚æ¨¡å¼ä¸æœ€ä½³å®è·µ
  - ç¤ºä¾‹ 9-24
  - è¦†ç›–ç‡ï¼šåŒ…å«æ‰€æœ‰é«˜çº§ç‰¹æ€§

### æŒ‰ä¸»é¢˜åˆ†ç±»

| ä¸»é¢˜ | ç¤ºä¾‹æ•° | è¦†ç›–çš„ API |
|------|--------|-----------|
| å¹¶å‘æ‰§è¡Œ | 6 | `spawn`, `spawn_bg`, `with_task_group` |
| è¶…æ—¶æ§åˆ¶ | 5 | `with_timeout`, `with_timeout_opt`, `TimeoutError` |
| é”™è¯¯å¤„ç† | 4 | `try/catch`, `allow_failure`, `fatal_error` |
| é‡è¯•ç­–ç•¥ | 4 | æ‰€æœ‰ 3 ç§ `RetryMethod` |
| å–æ¶ˆä¼ æ’­ | 3 | `cancel`, `protect_from_cancel` |
| èµ„æºç®¡ç† | 3 | `add_defer`, `spawn_loop` |
| å¹¶å‘æ§åˆ¶ | 3 | `Semaphore`, `Queue` |
| æ€§èƒ½ä¼˜åŒ– | 2 | `pause`, `now` |

---

## ğŸ¯ è¾¾åˆ° 90%+ è¦†ç›–ç‡çš„è¯æ®

### é‡åŒ–æŒ‡æ ‡

1. **æ•´ä½“ API è¦†ç›–ç‡ï¼š92.9%**
   - 28 ä¸ª API ä¸­ï¼Œ26 ä¸ªå·²è¦†ç›–
   - ä»…ç¼ºå°‘ 2 ä¸ªéé˜»å¡è¾…åŠ©æ–¹æ³•

2. **æ ¸å¿ƒåŠŸèƒ½è¦†ç›–ç‡ï¼š100%**
   - æ‰€æœ‰å…³é”®å¼‚æ­¥ç¼–ç¨‹ API å…¨è¦†ç›–
   - æ‰€æœ‰é‡è¯•ç­–ç•¥å…¨è¦†ç›–
   - æ‰€æœ‰è¶…æ—¶æœºåˆ¶å…¨è¦†ç›–

3. **ç¤ºä¾‹è´¨é‡**
   - 24 ä¸ªå¯è¿è¡Œç¤ºä¾‹
   - 24 ä¸ªå¿«ç…§æµ‹è¯•ï¼ˆ100% é€šè¿‡ç‡ï¼‰
   - 1257 è¡Œç²¾å¿ƒè®¾è®¡çš„ä»£ç 

### æœªè¦†ç›– API çš„è¯´æ˜

ä»… 2 ä¸ªæ–¹æ³•æœªè¦†ç›–ï¼ˆå  7.1%ï¼‰ï¼š

1. **`Queue::try_get()`**
   - éé˜»å¡è¯»å–é˜Ÿåˆ—
   - ä½¿ç”¨åœºæ™¯ï¼šéœ€è¦è½®è¯¢é˜Ÿåˆ—ä½†ä¸é˜»å¡æ—¶
   - æœªè¦†ç›–åŸå› ï¼šåœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œé€šå¸¸ä½¿ç”¨é˜»å¡çš„ `get()` æ›´ç¬¦åˆä¹ æƒ¯

2. **`Semaphore::try_acquire()`**
   - éé˜»å¡è·å–ä¿¡å·é‡
   - ä½¿ç”¨åœºæ™¯ï¼šéœ€è¦å°è¯•è·å–èµ„æºä½†ä¸ç­‰å¾…æ—¶
   - æœªè¦†ç›–åŸå› ï¼šåœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œé€šå¸¸ä½¿ç”¨é˜»å¡çš„ `acquire()` æ›´ç¬¦åˆä¹ æƒ¯

**è¿™ä¸¤ä¸ª API éƒ½æ˜¯éé˜»å¡çš„"try"å˜ä½“ï¼Œåœ¨å…¸å‹çš„å¼‚æ­¥ç¼–ç¨‹åœºæ™¯ä¸­ä½¿ç”¨è¾ƒå°‘ã€‚**

---

## ğŸ’¡ æå‡åˆ° 100% è¦†ç›–ç‡çš„å»ºè®®

å¦‚æœéœ€è¦è¾¾åˆ° 100% è¦†ç›–ç‡ï¼Œå¯ä»¥æ·»åŠ ä»¥ä¸‹ 2 ä¸ªç¤ºä¾‹ï¼š

### æ–°å¢ç¤ºä¾‹ 25ï¼šéé˜»å¡é˜Ÿåˆ—è½®è¯¢

```moonbit
/// æ¼”ç¤ºä½¿ç”¨ `Queue::try_get()` éé˜»å¡åœ°æ£€æŸ¥é˜Ÿåˆ—
pub fn demo_non_blocking_queue() -> Unit {
  @async.with_task_group(fn(root) {
    let q = @aqueue.Queue::new()
    
    root.spawn_bg(fn() {
      @async.sleep(100)
      q.put(42)
    })
    
    // éé˜»å¡æ£€æŸ¥
    loop {
      match q.try_get() {
        Some(value) => {
          println("Got: \{value}")
          break
        }
        None => {
          println("Queue empty, doing other work...")
          @async.sleep(20)
        }
      }
    }
  })
}
```

### æ–°å¢ç¤ºä¾‹ 26ï¼šéé˜»å¡ä¿¡å·é‡å°è¯•

```moonbit
/// æ¼”ç¤ºä½¿ç”¨ `Semaphore::try_acquire()` å°è¯•è·å–èµ„æº
pub fn demo_try_acquire_semaphore() -> Unit {
  @async.with_task_group(fn(root) {
    let sem = @semaphore.Semaphore::new(1)
    
    root.spawn_bg(fn() {
      sem.acquire()
      @async.sleep(100)
      sem.release()
    })
    
    @async.sleep(20)
    
    // å°è¯•éé˜»å¡è·å–
    if sem.try_acquire() {
      println("Acquired immediately!")
      sem.release()
    } else {
      println("Resource busy, waiting...")
      sem.acquire()
      println("Acquired after waiting!")
      sem.release()
    }
  })
}
```

---

## âœ… ç»“è®º

æœ¬é¡¹ç›®å·²æˆåŠŸè¾¾åˆ° **92.9% çš„ API è¦†ç›–ç‡**ï¼Œ**è¶…è¿‡ 90% çš„ç›®æ ‡**ï¼

### ä¼˜åŠ¿

1. âœ… **æ ¸å¿ƒ API 100% è¦†ç›–**ï¼šæ‰€æœ‰é‡è¦çš„å¼‚æ­¥ç¼–ç¨‹ API éƒ½æœ‰ç¤ºä¾‹
2. âœ… **å®ç”¨æ€§å¼º**ï¼š24 ä¸ªç¤ºä¾‹æ¶µç›–çœŸå®åœºæ™¯
3. âœ… **è´¨é‡é«˜**ï¼šæ‰€æœ‰ç¤ºä¾‹éƒ½æœ‰æµ‹è¯•ï¼Œ100% é€šè¿‡
4. âœ… **æ–‡æ¡£å®Œå–„**ï¼šæ¯ä¸ªç¤ºä¾‹éƒ½æœ‰è¯¦ç»†æ³¨é‡Š

### æœªè¦†ç›– API å½±å“

- ä»… 2 ä¸ªéé˜»å¡è¾…åŠ©æ–¹æ³•æœªè¦†ç›–ï¼ˆ7.1%ï¼‰
- è¿™äº›æ–¹æ³•åœ¨å…¸å‹å¼‚æ­¥ç¼–ç¨‹ä¸­ä½¿ç”¨è¾ƒå°‘
- ç”¨æˆ·å¯ä»¥é€šè¿‡é˜…è¯» API æ–‡æ¡£å¿«é€Ÿç†è§£å…¶ç”¨æ³•

**æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªé«˜è´¨é‡ã€é«˜è¦†ç›–ç‡çš„ MoonBit Async æœ€ä½³å®è·µç¤ºä¾‹åº“ï¼** ğŸš€

